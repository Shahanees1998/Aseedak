"use strict";(()=>{var e={};e.id=5756,e.ids=[5756],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9424:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>p,patchFetch:()=>v,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{GET:()=>u});var o=r(3277),a=r(5265),i=r(5356),s=r(7076);(function(){var e=Error("Cannot find module 'next-auth'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@prisma/client'");throw e.code="MODULE_NOT_FOUND",e}();let l=Object(function(){var e=Error("Cannot find module '@prisma/client'");throw e.code="MODULE_NOT_FOUND",e}())();async function u(e,{params:t}){try{let r=await Object(function(){var e=Error("Cannot find module 'next-auth'");throw e.code="MODULE_NOT_FOUND",e}())();if(!r||r.user?.role!=="HOTEL_ADMIN"||r.user?.hotelId!==t.hotelId)return s.NextResponse.json({error:"Unauthorized"},{status:401});let{hotelId:n}=t,{searchParams:o}=new URL(e.url),a=o.get("period")||"30",i=new Date;i.setDate(i.getDate()-parseInt(a));let[u,c,d,h,g,p,v,m,w]=await Promise.all([l.review.count({where:{hotelId:n}}),l.review.count({where:{hotelId:n,createdAt:{gte:i}}}),l.review.aggregate({where:{hotelId:n,overallRating:{not:null}},_avg:{overallRating:!0}}),l.review.groupBy({by:["overallRating"],where:{hotelId:n,overallRating:{not:null}},_count:{overallRating:!0}}),l.review.groupBy({by:["status"],where:{hotelId:n},_count:{status:!0}}),l.review.groupBy({by:["formId"],where:{hotelId:n},_count:{formId:!0}}),l.$queryRaw`
        SELECT 
          DATE_TRUNC('month', "createdAt") as month,
          COUNT(*) as count,
          AVG("overallRating") as avg_rating
        FROM "Review" 
        WHERE "hotelId" = ${n}
        AND "createdAt" >= NOW() - INTERVAL '12 months'
        GROUP BY DATE_TRUNC('month', "createdAt")
        ORDER BY month ASC
      `,l.review.count({where:{hotelId:n,adminNotes:{not:null}}}),l.form.findMany({where:{hotelId:n},include:{_count:{select:{reviews:!0}}},orderBy:{reviews:{_count:"desc"}},take:5})]),R=Array.from({length:5},(e,t)=>{let r=t+1,n=h.find(e=>e.overallRating===r)?._count.overallRating||0;return{rating:r,count:n}}),_=Array.from({length:12},(e,t)=>{let r=new Date;r.setMonth(r.getMonth()-(11-t));let n=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`,o=v.find(e=>e.month.toISOString().startsWith(n));return{month:n,count:o?.count||0,avgRating:o?.avg_rating?parseFloat(o.avg_rating):0}});return s.NextResponse.json({overview:{totalReviews:u,reviewsInPeriod:c,averageRating:d._avg.overallRating||0,responseRate:u>0?Math.round(m/u*100):0},ratingDistribution:R,reviewsByStatus:g.map(e=>({status:e.status,count:e._count.status})),monthlyTrends:_,topForms:w.map(e=>({id:e.id,name:e.name,reviewCount:e._count.reviews}))})}catch(e){return console.error("Error fetching analytics:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}let c=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/analytics/hotel/[hotelId]/route",pathname:"/api/analytics/hotel/[hotelId]",filename:"route",bundlePath:"app/api/analytics/hotel/[hotelId]/route"},resolvedPagePath:"/Users/mac/Documents/primochatadmin/hotel-feedback-saas/app/api/analytics/hotel/[hotelId]/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:h,serverHooks:g}=c,p="/api/analytics/hotel/[hotelId]/route";function v(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[916,3786],()=>r(9424));module.exports=n})();