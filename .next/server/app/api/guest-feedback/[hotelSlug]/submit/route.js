"use strict";(()=>{var e={};e.id=6002,e.ids=[6002],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3065:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>O,requestAsyncStorage:()=>f,routeModule:()=>c,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m});var o={};r.r(o),r.d(o,{POST:()=>l});var n=r(3277),s=r(5265),i=r(5356),a=r(7076);(function(){var e=Error("Cannot find module '@prisma/client'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module 'zod'");throw e.code="MODULE_NOT_FOUND",e}();let d=Object(function(){var e=Error("Cannot find module '@prisma/client'");throw e.code="MODULE_NOT_FOUND",e}())(),u=Object(function(){var e=Error("Cannot find module 'zod'");throw e.code="MODULE_NOT_FOUND",e}()).object({formId:Object(function(){var e=Error("Cannot find module 'zod'");throw e.code="MODULE_NOT_FOUND",e}()).string(),responses:Object(function(){var e=Error("Cannot find module 'zod'");throw e.code="MODULE_NOT_FOUND",e}()).record(Object(function(){var e=Error("Cannot find module 'zod'");throw e.code="MODULE_NOT_FOUND",e}()).any())});async function l(e,{params:t}){try{let{hotelSlug:o}=t,n=await e.json(),s=u.parse(n),i=await d.hotel.findUnique({where:{slug:o},select:{id:!0,isActive:!0}});if(!i||!i.isActive)return a.NextResponse.json({error:"Hotel not found or inactive"},{status:404});let l=await d.form.findFirst({where:{id:s.formId,hotelId:i.id,isActive:!0},include:{fields:!0}});if(!l)return a.NextResponse.json({error:"Form not found or inactive"},{status:404});let c=s.responses[l.fields.find(e=>e.label.toLowerCase().includes("name"))?.id||""],f=s.responses[l.fields.find(e=>"EMAIL"===e.type)?.id||""],m=s.responses[l.fields.find(e=>e.label.toLowerCase().includes("phone"))?.id||""],p=l.fields.find(e=>"RATING"===e.type),h=p?s.responses[p.id]:null,O="PENDING";h&&h>=4?O="APPROVED":h&&h<=2&&(O="PENDING");let v=await d.review.create({data:{hotelId:i.id,formId:l.id,guestName:c||null,guestEmail:f||null,guestPhone:m||null,responses:s.responses,overallRating:h||null,status:O}}),w=e.headers.get("referer");w&&w.includes("qr");try{let{sendEmail:e,emailTemplates:t}=await r.e(7862).then(r.bind(r,7862)),o=t.newReview(i.name,c||"Anonymous Guest",h||0),n=await d.user.findFirst({where:{hotelId:i.id,role:"HOTEL_ADMIN"},select:{email:!0,id:!0}});n&&(await e({to:n.email,subject:o.subject,html:o.html}),await d.notification.create({data:{userId:n.id,title:"New Guest Review",message:`${c||"Anonymous Guest"} left a ${h||0}-star review`,type:h&&h>=4?"success":"info",data:{reviewId:v.id,rating:h,guestName:c||"Anonymous Guest"}}}))}catch(e){console.error("Failed to send review notification email:",e)}return a.NextResponse.json({message:"Feedback submitted successfully",reviewId:v.id,status:v.status,overallRating:v.overallRating})}catch(e){if(console.error("Error submitting feedback:",e),e instanceof Object(function(){var e=Error("Cannot find module 'zod'");throw e.code="MODULE_NOT_FOUND",e}()).ZodError)return a.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return a.NextResponse.json({error:"Internal server error"},{status:500})}}let c=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/guest-feedback/[hotelSlug]/submit/route",pathname:"/api/guest-feedback/[hotelSlug]/submit",filename:"route",bundlePath:"app/api/guest-feedback/[hotelSlug]/submit/route"},resolvedPagePath:"/Users/mac/Documents/primochatadmin/hotel-feedback-saas/app/api/guest-feedback/[hotelSlug]/submit/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:p}=c,h="/api/guest-feedback/[hotelSlug]/submit/route";function O(){return(0,i.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[916,3786],()=>r(3065));module.exports=o})();