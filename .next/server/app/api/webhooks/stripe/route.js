"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3128:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>v,requestAsyncStorage:()=>_,routeModule:()=>E,serverHooks:()=>f,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{POST:()=>u});var o=r(3277),i=r(5265),s=r(5356),n=r(7076),c=r(8915);!function(){var e=Error("Cannot find module '@prisma/client'");throw e.code="MODULE_NOT_FOUND",e}();let d=Object(function(){var e=Error("Cannot find module '@prisma/client'");throw e.code="MODULE_NOT_FOUND",e}())();async function u(e){let t;let r=await e.text(),a=e.headers.get("stripe-signature");if(!a||!process.env.STRIPE_WEBHOOK_SECRET)return n.NextResponse.json({error:"Missing signature"},{status:400});try{t=c.Ag.webhooks.constructEvent(r,a,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook signature verification failed:",e),n.NextResponse.json({error:"Invalid signature"},{status:400})}try{switch(t.type){case"customer.subscription.created":await p(t.data.object);break;case"customer.subscription.updated":await l(t.data.object);break;case"customer.subscription.deleted":await h(t.data.object);break;case"invoice.payment_succeeded":await b(t.data.object);break;case"invoice.payment_failed":await m(t.data.object);break;default:console.log(`Unhandled event type: ${t.type}`)}return n.NextResponse.json({received:!0})}catch(e){return console.error("Webhook handler error:",e),n.NextResponse.json({error:"Webhook handler failed"},{status:500})}}async function p(e){let t=e.metadata.hotelId;if(!t){console.error("No hotelId in subscription metadata");return}await d.hotel.update({where:{id:t},data:{subscriptionStatus:"ACTIVE",subscriptionId:e.id,subscriptionStart:new Date(1e3*e.current_period_start),subscriptionEnd:new Date(1e3*e.current_period_end)}}),await d.subscription.create({data:{hotelId:t,stripeCustomerId:e.customer,stripeSubscriptionId:e.id,plan:e.items.data[0].price.nickname||"premium",status:"ACTIVE",currentPeriodStart:new Date(1e3*e.current_period_start),currentPeriodEnd:new Date(1e3*e.current_period_end),cancelAtPeriodEnd:e.cancel_at_period_end}}),console.log(`Subscription created for hotel ${t}`)}async function l(e){let t=e.metadata.hotelId;if(!t){console.error("No hotelId in subscription metadata");return}await d.hotel.update({where:{id:t},data:{subscriptionStatus:e.status.toUpperCase(),subscriptionEnd:new Date(1e3*e.current_period_end)}}),await d.subscription.updateMany({where:{stripeSubscriptionId:e.id},data:{status:e.status.toUpperCase(),currentPeriodEnd:new Date(1e3*e.current_period_end),cancelAtPeriodEnd:e.cancel_at_period_end}}),console.log(`Subscription updated for hotel ${t}`)}async function h(e){let t=e.metadata.hotelId;if(!t){console.error("No hotelId in subscription metadata");return}await d.hotel.update({where:{id:t},data:{subscriptionStatus:"CANCELLED"}}),await d.subscription.updateMany({where:{stripeSubscriptionId:e.id},data:{status:"CANCELLED"}}),console.log(`Subscription cancelled for hotel ${t}`)}async function b(e){if(e.subscription){let t=(await c.Ag.subscriptions.retrieve(e.subscription)).metadata.hotelId;t&&await d.hotel.update({where:{id:t},data:{subscriptionStatus:"ACTIVE"}})}}async function m(e){if(e.subscription){let t=(await c.Ag.subscriptions.retrieve(e.subscription)).metadata.hotelId;t&&await d.hotel.update({where:{id:t},data:{subscriptionStatus:"PAST_DUE"}})}}let E=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/Users/mac/Documents/primochatadmin/hotel-feedback-saas/app/api/webhooks/stripe/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:w,serverHooks:f}=E,S="/api/webhooks/stripe/route";function v(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:w})}},8915:(e,t,r)=>{if(r.d(t,{Ag:()=>a,Mc:()=>o}),function(){var e=Error("Cannot find module 'stripe'");throw e.code="MODULE_NOT_FOUND",e}(),!process.env.STRIPE_SECRET_KEY)throw Error("STRIPE_SECRET_KEY is not set");let a=Object(function(){var e=Error("Cannot find module 'stripe'");throw e.code="MODULE_NOT_FOUND",e}())(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16",typescript:!0});async function o(e,t,r,o,i){return await a.checkout.sessions.create({customer:e,payment_method_types:["card"],line_items:[{price:t,quantity:1}],mode:"subscription",success_url:o,cancel_url:i,metadata:{hotelId:r}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[916,3786],()=>r(3128));module.exports=a})();