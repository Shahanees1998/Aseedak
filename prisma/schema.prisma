// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum GameStatus {
  WAITING
  STARTING
  IN_PROGRESS
  FINISHED
}

enum PlayerStatus {
  ALIVE
  ELIMINATED
  WINNER
}

enum AvatarType {
  IMAGE1
  IMAGE2
  IMAGE3
  IMAGE4
  IMAGE5
  IMAGE6
  IMAGE7
  IMAGE8
  IMAGE9
  IMAGE10
}

model User {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  email     String     @unique
  password  String
  firstName String
  lastName  String
  username  String     @unique
  role      UserRole   @default(USER)
  avatar    AvatarType @default(IMAGE1)
  isActive  Boolean    @default(true)

  // Password reset
  resetToken       String?
  resetTokenExpiry DateTime?
  
  // Email verification
  emailVerified    Boolean   @default(false)
  emailVerifyToken String?
  emailVerifyExpiry DateTime?

  // Game statistics
  gamesPlayed Int @default(0)
  gamesWon    Int @default(0)
  totalKills  Int @default(0)

  // Relations
  gameRooms     GameRoom[]
  gamePlayers   GamePlayer[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Avatar {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  type        AvatarType @unique
  name        String
  description String
  imageUrl    String
  isUnlocked  Boolean    @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("avatars")
}

model Word {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  word1      String
  word2      String
  word3      String
  category   String // e.g., "animals", "food", "objects"
  difficulty String // "easy", "medium", "hard"
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("words")
}

model GameRoom {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  code       String     @unique
  maxPlayers Int        @default(8)
  status     GameStatus @default(WAITING)
  createdBy  String     @db.ObjectId
  creator    User       @relation(fields: [createdBy], references: [id])

  // Game settings
  wordSet      String[] // Array of word IDs
  currentRound Int      @default(1)
  timeLimit    Int      @default(60) // seconds per turn

  // Relations
  players           GamePlayer[]
  gameLogs          GameLog[]
  killConfirmations KillConfirmation[]

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  startedAt  DateTime?
  finishedAt DateTime?

  @@map("game_rooms")
}

model GamePlayer {
  id     String   @id @default(auto()) @map("_id") @db.ObjectId
  userId String   @db.ObjectId
  user   User     @relation(fields: [userId], references: [id])
  roomId String   @db.ObjectId
  room   GameRoom @relation(fields: [roomId], references: [id])

  // Player state
  status   PlayerStatus @default(ALIVE)
  position Int // Order in the game
  targetId String?      @db.ObjectId // ID of the player they need to eliminate
  target   GamePlayer?  @relation("PlayerTarget", fields: [targetId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  hunters  GamePlayer[] @relation("PlayerTarget")

  // Assigned words
  word1 String?
  word2 String?
  word3 String?

  // Game statistics
  kills        Int       @default(0)
  eliminatedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations for kill confirmations
  killerConfirmations KillConfirmation[] @relation("KillerConfirmations")
  targetConfirmations KillConfirmation[] @relation("TargetConfirmations")

  @@unique([userId, roomId])
  @@map("game_players")
}

model KillConfirmation {
  id     String   @id @default(auto()) @map("_id") @db.ObjectId
  roomId String   @db.ObjectId
  room   GameRoom @relation(fields: [roomId], references: [id])

  // Players involved
  killerId String     @db.ObjectId
  killer   GamePlayer @relation("KillerConfirmations", fields: [killerId], references: [id])
  targetId String     @db.ObjectId
  target   GamePlayer @relation("TargetConfirmations", fields: [targetId], references: [id])

  // Confirmation status
  status  String // "pending", "accepted", "rejected"
  message String? // Optional message from killer

  createdAt   DateTime  @default(now())
  respondedAt DateTime?

  @@map("kill_confirmations")
}

model GameLog {
  id     String   @id @default(auto()) @map("_id") @db.ObjectId
  roomId String   @db.ObjectId
  room   GameRoom @relation(fields: [roomId], references: [id])

  // Log details
  type    String // "elimination", "kill_request", "game_start", "game_end", "player_join", "player_leave"
  message String
  data    Json? // Additional data

  // Related players
  playerId String? @db.ObjectId
  targetId String? @db.ObjectId

  createdAt DateTime @default(now())

  @@map("game_logs")
}

model Notification {
  id      String  @id @default(auto()) @map("_id") @db.ObjectId
  userId  String  @db.ObjectId
  user    User    @relation(fields: [userId], references: [id])
  title   String
  message String
  type    String // "game_invite", "elimination", "game_start", "game_end", "system"
  isRead  Boolean @default(false)
  data    Json? // Additional data (roomId, gameId, etc.)

  createdAt DateTime @default(now())

  @@map("notifications")
}

model TermsAndConditions {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  version  String  @unique
  content  String
  isActive Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("terms_and_conditions")
}

model SystemSettings {
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  key   String @unique
  value Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}
